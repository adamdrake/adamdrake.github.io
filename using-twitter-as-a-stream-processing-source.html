<!doctype html><html lang=en><head><meta charset=utf-8><meta name=mobile-web-app-capable content="yes"><meta name=viewport content="width=device-width,initial-scale=1"><title>Using Twitter as a Stream Processing Source - Adam Drake
</title><meta name=description content="Adam Drake is an advisor to scale-up tech companies. He writes about ML/AI/crypto/data, leadership, and building tech teams."><link rel="shortcut icon" href=https://adamdrake.com/static/favicon.ico><link rel=authorization_endpoint href=https://indieauth.com/auth><link rel=token_endpoint href=https://tokens.indieauth.com/token><link rel=me href=https://github.com/adamdrake><link rel=stylesheet href=https://adamdrake.com/css/style.min.css crossorigin=anonymous media=screen><meta property="og:url" content="https://adamdrake.com/"><meta property="og:title" content="Adam Drake"><meta property="og:site_name" content="Adam Drake"><meta property="og:type" content="website"><meta property="og:description" content="Adam Drake is an advisor to scale-up tech companies. He writes about ML/AI/crypto/data, leadership, and building tech teams."><meta property="og:image" content="/static/images/twitter-card.jpg"><meta name=twitter:title content="Adam Drake"><meta name=twitter:description content="Adam Drake is an advisor to scale-up tech companies. He writes about ML/AI/crypto/data, leadership, and building tech teams."><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/static/images/twitter-card.jpg"></head><body><header><section><div class="header flex row"><div class="header__item flex row"><a id=site__name href=https://adamdrake.com/>Adam Drake</a></div><div class="flex row"><nav aria-label="page menu" class="flex row"><ul role=menubar class="flex row"><li role=none><a class=sidebar-nav-itemmenu__item href=/ title>Latest</a></li><li role=none><a class=sidebar-nav-itemmenu__item href=/about.html title>About</a></li><li role=none><a class=sidebar-nav-itemmenu__item href=/cases.html title>Case Studies</a></li><li role=none><a class=sidebar-nav-itemmenu__item href=/contact.html title>Contact</a></li><li role=none><a class="sidebar-nav-item activemenu__item" href=/posts.html title=Posts>Posts</a></li><li role=none><a class=sidebar-nav-itemmenu__item href=/press.html title>Press</a></li><li><button class="subscribe subscribe-btn">
<a href=https://www.digitalmaneuver.com/#/portal>Subscribe to newsletter</a></button></li></ul></nav></div></div></section></header><main aria-role=main><section><ul id=feed__ul><li class="feed__li h-entry"><div class=feed__content><time class="hidden dt-published">2014-06-11 00:00:00 +0000 UTC</time><div class="flex properties__row"><div rel=author class="flex left p-author h-card hidden"><img class=u-photo src=https://adamdrake.com/static/images/adam_drake_240.jpg alt="Adam Drake" id=author-img><div><p rel=me class=p-name id=author-name>Adam Drake</p><p class=properties>Jun 11, 2014</p></div></div><div class="flex right properties"></div></div><article class="md p-summary e-content"><h1 class=p-name>Using Twitter as a Stream Processing Source</h1><p>Recently, I was providing a lecture on stream processing and planned to use the Twitter streaming API as an example. To provide a framework for the attendees, I created the one below. It has been tested with Python 3.4 but as it does not include testing or other things it should only be used as an example.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> threading <span style=color:#f92672>import</span> Thread
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> collections <span style=color:#f92672>import</span> deque
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> twython <span style=color:#f92672>import</span> TwythonStreamer
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> requests.exceptions <span style=color:#f92672>import</span> ChunkedEncodingError
</span></span></code></pre></div><p>For the imports, we need them for the following reasons:</p><p>Thread as the consumer of the Twitter stream will run in a separate thread.</p><p>We use a double-ended queue (deque) as a lock-free way to move messages from one thread to another. Most operations on the deque are lock-free/atomic, and we will use <code>append()</code> and <code>popleft()</code> in this case and for that reason.</p><p><code>TwythonStreamer</code> is a Twitter Streaming API class from the twython library (<code>pip install twython</code> if you don&rsquo;t have it).</p><p>The <code>ChunkedEncodingError</code> exception is used to handle the case when the API responds with the wrong number of bytes, which it is known to do. In case that happens, we just call the stream consumer again with the same deque.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TwitterStream</span>(TwythonStreamer):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, consumer_key, consumer_secret, token, token_secret, tqueue):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>tweet_queue <span style=color:#f92672>=</span> tqueue
</span></span><span style=display:flex><span>        super(TwitterStream, self)<span style=color:#f92672>.</span>__init__(consumer_key, consumer_secret, token, token_secret)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>on_success</span>(self, data):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#39;text&#39;</span> <span style=color:#f92672>in</span> data:
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>tweet_queue<span style=color:#f92672>.</span>append(data)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>on_error</span>(self, status_code, data):
</span></span><span style=display:flex><span>        print(status_code)
</span></span><span style=display:flex><span>        <span style=color:#75715e># Want to stop trying to get data because of the error?</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Uncomment the next line!</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># self.disconnect()</span>
</span></span></code></pre></div><p>The <code>TwitterStream</code> class extends the <code>TwythonStreamer</code> class and provides information on what to do when a tweet is received and on errors. In this case, when the tweet is received we append it to the deque and on errors we simply print.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>stream_tweets</span>(tweets_queue):
</span></span><span style=display:flex><span>    <span style=color:#75715e># Input your credentials below</span>
</span></span><span style=display:flex><span>    consumer_key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>    consumer_secret <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>    token <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>    token_secret <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        stream <span style=color:#f92672>=</span> TwitterStream(consumer_key, consumer_secret, token, token_secret, tweets_queue)
</span></span><span style=display:flex><span>        <span style=color:#75715e># You can filter on keywords, or simply draw from the sample stream</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>#stream.statuses.filter(track=&#39;twitter&#39;, language=&#39;en&#39;)</span>
</span></span><span style=display:flex><span>        stream<span style=color:#f92672>.</span>statuses<span style=color:#f92672>.</span>sample(language<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;en&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> ChunkedEncodingError:
</span></span><span style=display:flex><span>        <span style=color:#75715e># Sometimes the API sends back one byte less than expected which results in an exception in the</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># current version of the requests library</span>
</span></span><span style=display:flex><span>        stream_tweets(tweet_queue)
</span></span></code></pre></div><p>This is the function that does most of the work, connecting to the streaming API, starting to sample from it, and handling the <code>ChunkedEncodingError</code> exceptions mentioned earlier.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>process_tweets</span>(tweets_queue):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> len(tweets_queue) <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>            <span style=color:#75715e>#  Do something with the tweets</span>
</span></span><span style=display:flex><span>            print(tweets_queue<span style=color:#f92672>.</span>popleft())
</span></span></code></pre></div><p>The process_tweets function is a small helper function that (inefficiently) loops over the deque and processes the contents element-wise.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    tweet_queue <span style=color:#f92672>=</span> deque()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    tweet_stream <span style=color:#f92672>=</span> Thread(target<span style=color:#f92672>=</span>stream_tweets, args<span style=color:#f92672>=</span>(tweet_queue,), daemon<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>    tweet_stream<span style=color:#f92672>.</span>start()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    process_tweets(tweet_queue)
</span></span></code></pre></div><p>Here we tie everything together by constructing the deque, starting the thread for the stream which will append to the deque, and the process tweet function that will handle the tweets.</p><p>So that was an easy skeleton for playing around with streams from Twitter, you can find the code in the <a href=https://github.com/adamdrake/twitterstreamtemplate>twitterstreamtemplate</a> repository on GitHub.</p><a class=hidden href=https://brid.gy/publish/mastodon></a><a class=hidden href=https://brid.gy/publish/twitter></a><a class=hidden href=https://fed.brid.gy/></a><data class=p-bridgy-omit-link value=false></data></article></div><div id=webmentions></div></li></ul></section></main><hr><footer class="flex col"><section class="footer-bio content"><p><strong>Adam Drake</strong> leads technical business transformations in global and multi-cultural environments. He has a passion for helping companies become more productive by improving internal leadership capabilities, and accelerating product development through technology and data architecture guidance. Adam has served as a White House Presidential Innovation Fellow and is an IEEE Senior Member.</p></section><button class="subscribe subscribe-btn">
<a href=https://www.digitalmaneuver.com/#/portal>Subscribe to newsletter</a></button><div class=social-icons><a rel=me href=https://github.com/adamdrake title=GitHub><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></div></footer></body></html>